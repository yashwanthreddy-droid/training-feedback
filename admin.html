<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training Feedback — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#005bab;
      --brand2:#003a63;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(2,6,23,0.08);
      --radius: 16px;
      --chip:#eef2ff;
      --chipText:#1e3a8a;
    }
    body.dark{
      --bg:#0b1220;
      --card:#0f1a2b;
      --text:#e5e7eb;
      --muted:#9aa4b2;
      --line:#1f2b3d;
      --shadow: 0 12px 40px rgba(0,0,0,0.35);
      --chip:#172554;
      --chipText:#dbeafe;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{
      max-width:1200px;
      margin:28px auto 60px;
      padding:0 16px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom:16px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title h1{
      margin:0;
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
      color:var(--brand2);
    }
    body.dark .title h1{ color:#cfe6ff; }
    .title p{
      margin:0;
      color:var(--muted);
      font-weight:600;
      font-size:13px;
      line-height:1.35;
    }
    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:none;
      background:var(--brand);
      color:#fff;
      font-weight:800;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      box-shadow:var(--shadow);
      transition:.12s ease;
      font-size:13px;
      white-space:nowrap;
    }
    .btn:hover{ transform:translateY(-1px); }
    .btn.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn.secondary:hover{ background:rgba(0,0,0,0.03); }
    body.dark .btn.secondary:hover{ background:rgba(255,255,255,0.04); }

    /* Filters */
    .filters{
      background:var(--card);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:14px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-bottom:16px;
    }
    .fgroup{
      min-width:200px;
      flex:1;
    }
    .fgroup label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      margin-bottom:6px;
    }
    select, input[type="text"]{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      font-weight:700;
      outline:none;
    }
    select:focus, input[type="text"]:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(0,91,171,0.15);
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--chip);
      color:var(--chipText);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(30,58,138,0.10);
    }
    body.dark .chip{ border-color: rgba(219,234,254,0.10); }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .kpis{ grid-column: 1 / -1; }
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:12px;
    }
    @media (max-width: 1100px){
      .kpiRow{ grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 640px){
      .kpiRow{ grid-template-columns: repeat(2, 1fr); }
    }
    .kpi{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(0,0,0,0.01);
    }
    body.dark .kpi{ background:rgba(255,255,255,0.02); }
    .kpi .label{
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      margin-bottom:6px;
    }
    .kpi .value{
      font-weight:900;
      font-size:22px;
      letter-spacing:.2px;
    }
    .kpi .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      line-height:1.25;
    }

    /* Charts */
    .chartCard h3{
      margin:0 0 10px;
      font-size:14px;
      font-weight:900;
      color:var(--text);
    }
    .chartCard canvas{
      width:100% !important;
      height:300px !important;
    }
    .c1{ grid-column: 1 / 7; }
    .c2{ grid-column: 7 / -1; }
    .c3{ grid-column: 1 / 7; }
    .c4{ grid-column: 7 / -1; }
    @media (max-width: 980px){
      .c1,.c2,.c3,.c4{ grid-column: 1 / -1; }
    }

    /* Table */
    .tableCard{ grid-column: 1 / -1; }
    .tableHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .tableHead h3{
      margin:0;
      font-size:14px;
      font-weight:900;
    }
    .tableWrap{
      overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 1100px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:12px;
    }
    th{
      position:sticky;
      top:0;
      background:var(--card);
      z-index:2;
      text-align:left;
      font-weight:900;
      color:var(--muted);
    }
    td{ font-weight:700; color:var(--text); }
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
      font-size:11px;
      border:1px solid var(--line);
      white-space:nowrap;
    }
    .pill.good{ color:var(--good); border-color:rgba(22,163,74,0.35); }
    .pill.warn{ color:var(--warn); border-color:rgba(245,158,11,0.35); }
    .pill.bad{ color:var(--bad); border-color:rgba(239,68,68,0.35); }

    .status{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .errorBox{
      display:none;
      margin-top:12px;
      border:1px solid rgba(239,68,68,0.35);
      background: rgba(239,68,68,0.08);
      padding:12px;
      border-radius:14px;
      font-weight:900;
      color:var(--bad);
      font-size:12px;
      line-height:1.35;
    }

    .small{
      font-size:11px;
      color:var(--muted);
      font-weight:800;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="title">
        <h1>Training Feedback — Admin Dashboard</h1>
        <p>Executive snapshot, trends, and training effectiveness/compliance parameters. Use filters to drill down by month and training topic.</p>
      </div>

      <div class="actions">
        <span class="chip" id="chipStatus">Status: Not loaded</span>
        <button class="btn secondary" id="btnToggleTheme">Dark mode</button>
        <button class="btn secondary" id="btnRefresh">Refresh</button>
        <button class="btn" id="btnExport">Export CSV</button>
      </div>
    </div>

    <div class="filters">
      <div class="fgroup">
        <label>Month</label>
        <select id="monthFilter">
          <option value="">All months</option>
        </select>
      </div>
      <div class="fgroup">
        <label>Training Topic</label>
        <select id="topicFilter">
          <option value="">All trainings</option>
        </select>
      </div>
      <div class="fgroup">
        <label>Search (employee code / department / location)</label>
        <input type="text" id="searchBox" placeholder="Type to filter table…">
      </div>
      <div class="fgroup" style="min-width:220px;">
        <label>Thresholds</label>
        <div class="row" style="display:flex; gap:10px;">
          <input type="text" id="minRating" value="3.5" title="Min rating threshold" style="max-width:90px;" />
          <input type="text" id="minNps" value="6" title="Min NPS threshold" style="max-width:90px;" />
          <span class="small">Min Avg Rating / Min NPS</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card kpis">
        <div class="kpiRow">
          <div class="kpi">
            <div class="label">Total Responses</div>
            <div class="value" id="kpiTotal">—</div>
            <div class="sub">Filtered view count</div>
          </div>
          <div class="kpi">
            <div class="label">Avg Overall Rating</div>
            <div class="value" id="kpiAvgOverall">—</div>
            <div class="sub">1–5 scale</div>
          </div>
          <div class="kpi">
            <div class="label">Avg NPS</div>
            <div class="value" id="kpiAvgNps">—</div>
            <div class="sub">0–10 scale</div>
          </div>
          <div class="kpi">
            <div class="label">Avg Trainer Score</div>
            <div class="value" id="kpiAvgTrainer">—</div>
            <div class="sub">Avg of trainer ratings</div>
          </div>
          <div class="kpi">
            <div class="label">Avg Effectiveness Score</div>
            <div class="value" id="kpiAvgCompliance">—</div>
            <div class="sub">Avg of effectiveness/compliance ratings</div>
          </div>
          <div class="kpi">
            <div class="label">Quiz Completed</div>
            <div class="value" id="kpiQuizPct">—</div>
            <div class="sub">% Yes (filtered)</div>
          </div>
        </div>

        <div class="status" id="metaLine">—</div>
        <div class="errorBox" id="errorBox"></div>
      </div>

      <div class="card chartCard c1">
        <h3>Monthly Trend — Avg Overall Rating</h3>
        <canvas id="chartTrendRating"></canvas>
      </div>

      <div class="card chartCard c2">
        <h3>Monthly Trend — Avg Effectiveness Score</h3>
        <canvas id="chartTrendCompliance"></canvas>
      </div>

      <div class="card chartCard c3">
        <h3>Ratings by Training (Avg Overall)</h3>
        <canvas id="chartByTraining"></canvas>
      </div>

      <div class="card chartCard c4">
        <h3>NPS Distribution (0–10)</h3>
        <canvas id="chartNpsDist"></canvas>
      </div>

      <div class="card tableCard">
        <div class="tableHead">
          <h3>Responses (Verbatim + Scores)</h3>
          <div class="small">Tip: use the search box to filter rows. Export uses the current filtered dataset.</div>
        </div>
        <div class="tableWrap">
          <table id="tbl">
            <thead>
              <tr>
                <th>Date</th>
                <th>Training</th>
                <th>Location</th>
                <th>Employee</th>
                <th>Department</th>
                <th>Overall</th>
                <th>NPS</th>
                <th>Trainer</th>
                <th>Effectiveness</th>
                <th>Quiz</th>
                <th>Liked Most</th>
                <th>Improve</th>
                <th>Suggestions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script>
  /********************
   * CONFIG
   ********************/
  const API_URL = "https://script.google.com/macros/s/AKfycby4qy0LBzj21Fb_sOU3VaaimYy7uGEY7Q5D9v4LeMCgculx6_tMpKP5MtekPsTd2_i5jg/exec";

  // Basic client-side password gate (not secure; prevents casual access only)
  const ADMIN_PASSWORD = "HGS@123";
  const PASS_KEY = "tf_admin_authed_v1";

  // Fields expected from backend rows
  const F = {
    trainingTopic: "trainingTopic",
    trainingDate: "trainingDate",
    location: "location",
    employeeCode: "employeeCode",
    department: "department",

    overallRating: "overallRating",
    contentRelevanceRating: "contentRelevanceRating",
    trainerDeliveryRating: "trainerDeliveryRating",
    sessionPaceRating: "sessionPaceRating",
    usefulnessRating: "usefulnessRating",

    trainerKnowledgeRating: "trainerKnowledgeRating",
    trainerEngagementRating: "trainerEngagementRating",
    trainerResponsivenessRating: "trainerResponsivenessRating",
    trainerExamplesRating: "trainerExamplesRating",

    iso_objectives_clarity: "iso_objectives_clarity",
    iso_role_alignment: "iso_role_alignment",
    iso_competence_gain: "iso_competence_gain",
    iso_material_quality: "iso_material_quality",
    iso_learning_environment: "iso_learning_environment",
    iso_assessment_completed: "iso_assessment_completed",

    npsScore: "npsScore",
    likedMost: "likedMost",
    toImprove: "toImprove",
    suggestions: "suggestions",
    createdAt: "createdAt",
  };

  /********************
   * STATE
   ********************/
  let allRows = [];
  let filteredRows = [];

  let chartTrendRating, chartTrendCompliance, chartByTraining, chartNpsDist;

  const els = {
    chipStatus: document.getElementById("chipStatus"),
    btnToggleTheme: document.getElementById("btnToggleTheme"),
    btnRefresh: document.getElementById("btnRefresh"),
    btnExport: document.getElementById("btnExport"),

    monthFilter: document.getElementById("monthFilter"),
    topicFilter: document.getElementById("topicFilter"),
    searchBox: document.getElementById("searchBox"),
    minRating: document.getElementById("minRating"),
    minNps: document.getElementById("minNps"),

    kpiTotal: document.getElementById("kpiTotal"),
    kpiAvgOverall: document.getElementById("kpiAvgOverall"),
    kpiAvgNps: document.getElementById("kpiAvgNps"),
    kpiAvgTrainer: document.getElementById("kpiAvgTrainer"),
    kpiAvgCompliance: document.getElementById("kpiAvgCompliance"),
    kpiQuizPct: document.getElementById("kpiQuizPct"),

    metaLine: document.getElementById("metaLine"),
    errorBox: document.getElementById("errorBox"),
    tbody: document.getElementById("tbody"),
  };

  /********************
   * AUTH GATE
   ********************/
  function requirePassword(){
    const authed = localStorage.getItem(PASS_KEY) === "1";
    if (authed) return true;

    const entered = prompt("Enter Admin Password:");
    if (entered === null) return false;
    if (entered === ADMIN_PASSWORD) {
      localStorage.setItem(PASS_KEY, "1");
      return true;
    }
    alert("Incorrect password.");
    return false;
  }

  /********************
   * UTIL
   ********************/
  function setStatus(text){
    els.chipStatus.textContent = "Status: " + text;
  }

  function showError(msg){
    els.errorBox.style.display = "block";
    els.errorBox.textContent = msg;
  }

  function clearError(){
    els.errorBox.style.display = "none";
    els.errorBox.textContent = "";
  }

  function asNum(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function fmt1(n){
    if (n === null || n === undefined) return "—";
    return (Math.round(n * 10) / 10).toFixed(1);
  }

  function fmtPct(n){
    if (n === null || n === undefined) return "—";
    return Math.round(n) + "%";
  }

  function toMonthKey(dateStr){
    // expects YYYY-MM-DD
    if (!dateStr || typeof dateStr !== "string") return "";
    return dateStr.slice(0,7);
  }

  function safeStr(v){
    return (v === null || v === undefined) ? "" : String(v);
  }

  function avg(nums){
    const arr = nums.filter(n => Number.isFinite(n));
    if (!arr.length) return null;
    return arr.reduce((a,b)=>a+b,0) / arr.length;
  }

  function clampText(s, max=180){
    const t = safeStr(s).trim();
    if (t.length <= max) return t;
    return t.slice(0, max) + "…";
  }

  function ratingPill(val, warnThreshold, badThreshold){
    const n = asNum(val);
    if (n === null) return `<span class="pill">—</span>`;
    let cls = "good";
    if (n < badThreshold) cls = "bad";
    else if (n < warnThreshold) cls = "warn";
    return `<span class="pill ${cls}">${fmt1(n)}</span>`;
  }

  function yesNoPill(v){
    const s = safeStr(v).trim().toLowerCase();
    if (!s) return `<span class="pill">—</span>`;
    if (s === "yes") return `<span class="pill good">Yes</span>`;
    if (s === "no") return `<span class="pill bad">No</span>`;
    return `<span class="pill">${safeStr(v)}</span>`;
  }

  function computeTrainerScore(row){
    // Avg of trainer ratings (knowledge, engagement, responsiveness, examples, plus delivery if present)
    const nums = [
      asNum(row[F.trainerKnowledgeRating]),
      asNum(row[F.trainerEngagementRating]),
      asNum(row[F.trainerResponsivenessRating]),
      asNum(row[F.trainerExamplesRating]),
      asNum(row[F.trainerDeliveryRating]),
    ].filter(n => n !== null);
    return avg(nums);
  }

  function computeComplianceScore(row){
    // Avg of effectiveness/compliance ratings
    const nums = [
      asNum(row[F.iso_objectives_clarity]),
      asNum(row[F.iso_role_alignment]),
      asNum(row[F.iso_competence_gain]),
      asNum(row[F.iso_material_quality]),
      asNum(row[F.iso_learning_environment]),
    ].filter(n => n !== null);
    return avg(nums);
  }

  function csvEscape(s){
    const t = safeStr(s);
    if (/[",\n]/.test(t)) return `"${t.replace(/"/g,'""')}"`;
    return t;
  }

  /********************
   * FETCH
   ********************/
  async function fetchAll(){
    clearError();
    setStatus("Loading…");

    const res = await fetch(API_URL, { method:"GET" });
    const data = await res.json().catch(()=> ({}));

    if (!res.ok || data.status !== "ok" || !Array.isArray(data.rows)){
      throw new Error(data.message || `Backend error (HTTP ${res.status}). Ensure Code.gs has doGet() and redeployed as Web App.`);
    }

    allRows = data.rows.map(r => normalizeRow(r));
    setStatus(`Loaded (${allRows.length})`);
    els.metaLine.textContent = `Backend loaded. Records: ${allRows.length}. Last refresh: ${new Date().toLocaleString()}`;
  }

  function normalizeRow(r){
    // Ensure fields exist and date normalized
    const o = Object.assign({}, r);
    // Some sheets may return Date objects; coerce to string if possible
    o[F.trainingDate] = safeStr(o[F.trainingDate]).slice(0,10); // best-effort
    return o;
  }

  /********************
   * FILTERING
   ********************/
  function buildFilters(){
    // months
    const months = Array.from(new Set(allRows.map(r => toMonthKey(r[F.trainingDate])).filter(Boolean))).sort().reverse();
    const topics = Array.from(new Set(allRows.map(r => safeStr(r[F.trainingTopic]).trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

    // month filter
    els.monthFilter.innerHTML = `<option value="">All months</option>` + months.map(m=>`<option value="${m}">${m}</option>`).join("");

    // topic filter
    els.topicFilter.innerHTML = `<option value="">All trainings</option>` + topics.map(t=>`<option value="${encodeURIComponent(t)}">${t}</option>`).join("");
  }

  function applyFilters(){
    const month = els.monthFilter.value;
    const topic = decodeURIComponent(els.topicFilter.value || "");
    const q = els.searchBox.value.trim().toLowerCase();

    filteredRows = allRows.filter(r => {
      if (month && toMonthKey(r[F.trainingDate]) !== month) return false;
      if (topic && safeStr(r[F.trainingTopic]).trim() !== topic) return false;

      if (q){
        const hay = [
          r[F.employeeCode],
          r[F.department],
          r[F.location],
          r[F.trainingTopic],
        ].map(safeStr).join(" ").toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });

    renderKPIs();
    renderCharts();
    renderTable();
  }

  /********************
   * KPIs
   ********************/
  function renderKPIs(){
    const total = filteredRows.length;

    const avgOverall = avg(filteredRows.map(r => asNum(r[F.overallRating])).filter(n=>n!==null));
    const avgNps = avg(filteredRows.map(r => asNum(r[F.npsScore])).filter(n=>n!==null));

    const avgTrainer = avg(filteredRows.map(r => computeTrainerScore(r)).filter(n=>n!==null));
    const avgCompliance = avg(filteredRows.map(r => computeComplianceScore(r)).filter(n=>n!==null));

    // Quiz completion %
    const quizVals = filteredRows.map(r => safeStr(r[F.iso_assessment_completed]).trim().toLowerCase()).filter(Boolean);
    const yesCount = quizVals.filter(v => v === "yes").length;
    const quizPct = quizVals.length ? (yesCount / quizVals.length) * 100 : null;

    els.kpiTotal.textContent = total ? String(total) : "0";
    els.kpiAvgOverall.textContent = fmt1(avgOverall);
    els.kpiAvgNps.textContent = fmt1(avgNps);
    els.kpiAvgTrainer.textContent = fmt1(avgTrainer);
    els.kpiAvgCompliance.textContent = fmt1(avgCompliance);
    els.kpiQuizPct.textContent = fmtPct(quizPct);

    // Status chip
    const minRating = Number(els.minRating.value || "3.5");
    const minNps = Number(els.minNps.value || "6");
    const needsAttention = (avgOverall !== null && avgOverall < minRating) || (avgNps !== null && avgNps < minNps);
    els.chipStatus.textContent = "Status: " + (needsAttention ? "Needs attention" : "On track");
    els.chipStatus.style.background = needsAttention ? "rgba(245,158,11,0.15)" : "rgba(22,163,74,0.12)";
    els.chipStatus.style.color = needsAttention ? "#92400e" : "#065f46";
    els.chipStatus.style.borderColor = "rgba(0,0,0,0.08)";
    if (document.body.classList.contains("dark")){
      els.chipStatus.style.borderColor = "rgba(255,255,255,0.10)";
      els.chipStatus.style.color = needsAttention ? "#fbbf24" : "#34d399";
    }
  }

  /********************
   * CHARTS
   ********************/
  function destroyChart(ch){
    if (ch && typeof ch.destroy === "function") ch.destroy();
  }

  function monthlySeries(rows, valueFn){
    // returns {labels:[YYYY-MM], values:[avg]}
    const map = new Map();
    rows.forEach(r=>{
      const m = toMonthKey(r[F.trainingDate]);
      if (!m) return;
      const v = valueFn(r);
      if (v === null || !Number.isFinite(v)) return;
      if (!map.has(m)) map.set(m, []);
      map.get(m).push(v);
    });
    const labels = Array.from(map.keys()).sort();
    const values = labels.map(l => avg(map.get(l)));
    return { labels, values };
  }

  function renderCharts(){
    // Monthly trend rating
    const s1 = monthlySeries(filteredRows, r => asNum(r[F.overallRating]));
    destroyChart(chartTrendRating);
    chartTrendRating = new Chart(document.getElementById("chartTrendRating"), {
      type: "line",
      data: { labels: s1.labels, datasets: [{ label: "Avg Overall Rating", data: s1.values, tension: 0.25 }] },
      options: baseChartOptions({ yMin: 0, yMax: 5, yStep: 1 })
    });

    // Monthly trend compliance/effectiveness
    const s2 = monthlySeries(filteredRows, r => computeComplianceScore(r));
    destroyChart(chartTrendCompliance);
    chartTrendCompliance = new Chart(document.getElementById("chartTrendCompliance"), {
      type: "line",
      data: { labels: s2.labels, datasets: [{ label: "Avg Effectiveness Score", data: s2.values, tension: 0.25 }] },
      options: baseChartOptions({ yMin: 0, yMax: 5, yStep: 1 })
    });

    // Avg overall by training
    const byTraining = groupAvg(filteredRows, r => safeStr(r[F.trainingTopic]).trim() || "(Blank)", r => asNum(r[F.overallRating]));
    destroyChart(chartByTraining);
    chartByTraining = new Chart(document.getElementById("chartByTraining"), {
      type: "bar",
      data: {
        labels: byTraining.labels,
        datasets: [{ label: "Avg Overall Rating", data: byTraining.values }]
      },
      options: baseChartOptions({ yMin: 0, yMax: 5, yStep: 1 })
    });

    // NPS distribution (0-10 counts)
    const dist = new Array(11).fill(0);
    filteredRows.forEach(r => {
      const n = asNum(r[F.npsScore]);
      if (n === null) return;
      const k = Math.max(0, Math.min(10, Math.round(n)));
      dist[k] += 1;
    });
    destroyChart(chartNpsDist);
    chartNpsDist = new Chart(document.getElementById("chartNpsDist"), {
      type: "bar",
      data: {
        labels: Array.from({length: 11}, (_,i)=>String(i)),
        datasets: [{ label: "Responses", data: dist }]
      },
      options: baseChartOptions({ yMin: 0 })
    });
  }

  function groupAvg(rows, keyFn, valFn){
    const map = new Map();
    rows.forEach(r=>{
      const k = keyFn(r);
      const v = valFn(r);
      if (v === null || !Number.isFinite(v)) return;
      if (!map.has(k)) map.set(k, []);
      map.get(k).push(v);
    });
    // sort by value desc, show top 12 (keep chart readable)
    const entries = Array.from(map.entries())
      .map(([k,arr])=>({ k, v: avg(arr) }))
      .sort((a,b)=> (b.v||0) - (a.v||0))
      .slice(0, 12);

    return {
      labels: entries.map(e => e.k),
      values: entries.map(e => e.v),
    };
  }

  function baseChartOptions({yMin=null,yMax=null,yStep=null}={}){
    const dark = document.body.classList.contains("dark");
    return {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: dark ? "#e5e7eb" : "#0f172a", font: { weight: 800 } } },
        tooltip: { enabled: true }
      },
      scales: {
        x: {
          ticks: { color: dark ? "#9aa4b2" : "#64748b", font: { weight: 800 } },
          grid: { color: dark ? "rgba(255,255,255,0.06)" : "rgba(2,6,23,0.06)" }
        },
        y: {
          min: yMin === null ? undefined : yMin,
          max: yMax === null ? undefined : yMax,
          ticks: {
            stepSize: yStep === null ? undefined : yStep,
            color: dark ? "#9aa4b2" : "#64748b",
            font: { weight: 800 }
          },
          grid: { color: dark ? "rgba(255,255,255,0.06)" : "rgba(2,6,23,0.06)" }
        }
      }
    };
  }

  /********************
   * TABLE
   ********************/
  function renderTable(){
    const minRating = Number(els.minRating.value || "3.5");
    const minNps = Number(els.minNps.value || "6");

    const rows = filteredRows
      .slice()
      .sort((a,b)=> safeStr(b[F.trainingDate]).localeCompare(safeStr(a[F.trainingDate])));

    const html = rows.map(r => {
      const overall = asNum(r[F.overallRating]);
      const nps = asNum(r[F.npsScore]);
      const trainer = computeTrainerScore(r);
      const comp = computeComplianceScore(r);
      const quiz = safeStr(r[F.iso_assessment_completed]);

      // attention logic
      const overallP = ratingPill(overall, minRating, minRating - 0.5);
      const npsP = (nps === null) ? `<span class="pill">—</span>` :
        (nps < minNps ? `<span class="pill bad">${fmt1(nps)}</span>` : `<span class="pill good">${fmt1(nps)}</span>`);

      return `
        <tr>
          <td>${safeStr(r[F.trainingDate]) || "—"}</td>
          <td>${safeStr(r[F.trainingTopic]) || "—"}</td>
          <td>${safeStr(r[F.location]) || "—"}</td>
          <td>${safeStr(r[F.employeeCode]) || "—"}</td>
          <td>${safeStr(r[F.department]) || "—"}</td>
          <td>${overallP}</td>
          <td>${npsP}</td>
          <td>${ratingPill(trainer, minRating, minRating - 0.5)}</td>
          <td>${ratingPill(comp, minRating, minRating - 0.5)}</td>
          <td>${yesNoPill(quiz)}</td>
          <td>${clampText(r[F.likedMost]) || "—"}</td>
          <td>${clampText(r[F.toImprove]) || "—"}</td>
          <td>${clampText(r[F.suggestions]) || "—"}</td>
        </tr>
      `;
    }).join("");

    els.tbody.innerHTML = html || `<tr><td colspan="13" style="padding:14px; color:var(--muted); font-weight:900;">No records found for the current filters.</td></tr>`;
  }

  /********************
   * EXPORT CSV
   ********************/
  function exportCSV(){
    const rows = filteredRows.slice().sort((a,b)=> safeStr(a[F.trainingDate]).localeCompare(safeStr(b[F.trainingDate])));

    const headers = [
      "trainingDate","trainingTopic","location","employeeCode","department",
      "overallRating","contentRelevanceRating","trainerDeliveryRating","sessionPaceRating","usefulnessRating",
      "trainerKnowledgeRating","trainerEngagementRating","trainerResponsivenessRating","trainerExamplesRating",
      "iso_objectives_clarity","iso_role_alignment","iso_competence_gain","iso_material_quality","iso_learning_environment",
      "iso_assessment_completed",
      "npsScore","likedMost","toImprove","suggestions","createdAt"
    ];

    const lines = [];
    lines.push(headers.join(","));
    rows.forEach(r=>{
      const line = headers.map(h => csvEscape(r[h]));
      lines.push(line.join(","));
    });

    const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `training_feedback_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /********************
   * EVENTS
   ********************/
  els.btnToggleTheme.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    // re-render charts to update axis label colors
    renderCharts();
  });

  els.btnRefresh.addEventListener("click", async () => {
    await boot();
  });

  els.btnExport.addEventListener("click", exportCSV);

  els.monthFilter.addEventListener("change", applyFilters);
  els.topicFilter.addEventListener("change", applyFilters);
  els.searchBox.addEventListener("input", applyFilters);
  els.minRating.addEventListener("input", applyFilters);
  els.minNps.addEventListener("input", applyFilters);

  /********************
   * BOOT
   ********************/
  async function boot(){
    clearError();

    // Gate
    if (!requirePassword()){
      setStatus("Locked");
      return;
    }

    try{
      await fetchAll();
      buildFilters();
      applyFilters();
    }catch(err){
      setStatus("Error");
      showError(
        "Admin dashboard could not load data.\n\n" +
        "Most common causes:\n" +
        "1) Code.gs not redeployed after adding doGet()\n" +
        "2) Web App access not set to 'Anyone'\n" +
        "3) Wrong /exec URL\n\n" +
        "Technical details: " + err.message
      );
      allRows = [];
      filteredRows = [];
      renderKPIs();
      renderTable();
      destroyChart(chartTrendRating);
      destroyChart(chartTrendCompliance);
      destroyChart(chartByTraining);
      destroyChart(chartNpsDist);
    }
  }

  // Start
  boot();
</script>

</body>
</html>

