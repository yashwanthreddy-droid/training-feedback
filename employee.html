<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Training Feedback</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

<!-- Flatpickr (optional enhancement; form still works without it) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">

<style>
  :root{
    --bg:#f4f6f9; --card:#fff; --text:#1b2430; --muted:#5d6b7a;
    --brand:#005bab; --border:#cfd8e3; --danger:#b42318;
    --successBg:#e8f7ee; --successText:#0a6b38;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; background:var(--bg); font-family:Inter, sans-serif; color:var(--text); }
  .container{
    max-width:920px; margin:40px auto; background:var(--card); padding:36px;
    border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.08);
  }
  .header{ text-align:center; margin-bottom:26px; }
  .header h2{ margin:0; color:#003a63; font-weight:900; letter-spacing:.2px; }
  .header p{ margin:10px 0 0; color:var(--muted); font-weight:600; font-size:13px; line-height:1.45; }

  .section{ margin-top:28px; }
  .section h3{ margin:0 0 10px; color:#0b2b4a; font-size:16px; font-weight:900; }

  label{ font-weight:800; display:block; margin:16px 0 6px; color:#2b3a4a; font-size:13px; }

  input, select, textarea{
    width:100%; padding:12px; border-radius:12px; border:1px solid var(--border);
    font-size:14px; background:#fff; color:var(--text);
  }
  input:focus, select:focus, textarea:focus{
    border-color:var(--brand); outline:none; box-shadow:0 0 0 3px rgba(0,91,171,0.12);
  }
  textarea{ min-height:92px; resize:vertical; }

  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .row > *{ flex:1; min-width:220px; }

  .helper{ margin-top:8px; color:var(--muted); font-weight:600; font-size:12px; line-height:1.4; }
  .error{ display:none; margin-top:8px; color:var(--danger); font-weight:900; font-size:12px; }

  .rating-row{ margin-top:14px; }
  .rating-head{ display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
  .rating-selected{ font-size:12px; font-weight:900; color:var(--muted); }
  .rating-selected strong{ color:#0b2b4a; }

  .rating-buttons{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .rating-buttons button{
    width:46px; height:46px; border-radius:999px;
    border:2px solid #c7d2e0; background:#f7f9fc; color:var(--text);
    font-weight:900; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
    transition:.15s ease; user-select:none;
  }
  .rating-buttons button:hover{ border-color:var(--brand); box-shadow:0 10px 20px rgba(0,0,0,.10); transform:translateY(-1px); }
  .rating-buttons button.selected{ background:var(--brand); border-color:var(--brand); color:#fff; }

  .yn-buttons{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .yn-buttons button{
    padding:10px 14px; border-radius:999px; border:2px solid #c7d2e0;
    background:#f7f9fc; font-weight:900; cursor:pointer; transition:.15s ease;
  }
  .yn-buttons button:hover{ border-color:var(--brand); box-shadow:0 10px 20px rgba(0,0,0,.08); transform:translateY(-1px); }
  .yn-buttons button.selected{ background:var(--brand); border-color:var(--brand); color:#fff; }

  .submit-btn{
    margin-top:30px; width:100%; padding:16px; font-size:17px;
    border-radius:14px; border:none; background:var(--brand); color:#fff;
    font-weight:900; cursor:pointer; transition:.15s ease;
  }
  .submit-btn:disabled{ background:#9bbad1; cursor:not-allowed; }

  .success{
    margin-top:18px; background:var(--successBg); color:var(--successText);
    padding:14px; border-radius:12px; font-weight:900; display:none; text-align:center;
  }
  .footer-note{ margin-top:14px; text-align:center; color:#7b8796; font-size:12px; font-weight:600; }

  .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange{
    background:var(--brand); border-color:var(--brand);
  }
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h2>Training Feedback Form</h2>
    <p>Please share your honest feedback to help us improve learning experiences. Fields marked * are mandatory.</p>
  </div>

  <!-- Session Details -->
  <div class="section">
    <h3>Session Details</h3>

    <label>Training Topic *</label>
    <input id="trainingTopic" placeholder="e.g., Email Skills, Power Query, POSH">

    <label>Training Date *</label>
    <!-- Native date picker always works. Flatpickr enhances it if CDN loads. -->
    <input type="date" id="trainingDate">
    <div class="helper">Allowed range: last 60 days only (no future dates).</div>
    <div id="dateError" class="error">Please select a valid training date (within the last 60 days).</div>

    <label>Location *</label>
    <select id="location">
      <option value="">Select</option>
      <option>OIC</option>
      <option>BSEL</option>
      <option>SV & PK</option>
      <option>IRIS</option>
      <option>Bangalore</option>
      <option>Virtual</option>
    </select>

    <label>Employee Code *</label>
    <div class="row">
      <select id="empPrefix" style="max-width:160px;">
        <option value="">Select</option>
        <option value="BS">BS</option>
        <option value="HGSI">HGSI</option>
      </select>
      <input id="employeeCode" placeholder="Enter employee code (e.g., 12345)">
    </div>
    <div class="helper">Example: BS-12345 or HGSI-67890</div>

    <label>Department *</label>
    <select id="department">
      <option value="">Select Department</option>
      <option>PF COMPLIANCE</option>
      <option>EXTERNAL TA</option>
      <option>INTERNAL F & A</option>
      <option>INFORMATION & TECHNOLOGY</option>
      <option>F & A - EXPENSES PROCESSING</option>
      <option>HUMAN RESOURCES</option>
      <option>SUPPORT SERVICES</option>
      <option>COMPLIANCE</option>
      <option>PAYROLL OPERATIONS</option>
      <option>F & A SHARED SERVICES</option>
      <option>SUPPORT SERVICES-IMS</option>
      <option>HR SERVICES</option>
      <option>BUSINESS DEVELOPMENT</option>
      <option>PT COMPLIANCE</option>
      <option>REIMBURSEMENT</option>
      <option>LEGAL</option>
      <option>EXTERNAL F & A</option>
      <option>STRATEGY AND OPERATIONS</option>
      <option>ADMINISTRATION</option>
      <option>FDATA</option>
      <option>OTHERS</option>
      <option>OPERATIONS</option>
    </select>
  </div>

  <!-- Session Ratings -->
  <div class="section">
    <h3>Session Ratings (1 = Poor, 5 = Excellent) *</h3>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Overall Session Rating *</label>
        <div class="rating-selected">Selected: <strong id="sel_overallRating">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="overallRating">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Content relevance to your work *</label>
        <div class="rating-selected">Selected: <strong id="sel_contentRelevanceRating">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="contentRelevanceRating">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Trainer clarity & delivery *</label>
        <div class="rating-selected">Selected: <strong id="sel_trainerDeliveryRating">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="trainerDeliveryRating">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Session pace *</label>
        <div class="rating-selected">Selected: <strong id="sel_sessionPaceRating">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="sessionPaceRating">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Usefulness for your current role *</label>
        <div class="rating-selected">Selected: <strong id="sel_usefulnessRating">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="usefulnessRating">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>
  </div>

  <!-- Trainer Feedback -->
  <div class="section">
    <h3>Trainer Feedback (1 = Poor, 5 = Excellent) *</h3>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Trainer subject knowledge *</label>
        <div class="rating-selected">Selected: <strong id="sel_trainerKnowledgeRating">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="trainerKnowledgeRating">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Trainer engagement & interaction *</label>
        <div class="rating-selected">Selected: <strong id="sel_trainerEngagementRating">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="trainerEngagementRating">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Trainer responsiveness to questions *</label>
        <div class="rating-selected">Selected: <strong id="sel_trainerResponsivenessRating">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="trainerResponsivenessRating">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Use of examples / practical applicability *</label>
        <div class="rating-selected">Selected: <strong id="sel_trainerExamplesRating">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="trainerExamplesRating">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <label>What did the trainer do well? (Optional)</label>
    <textarea id="trainerStrengths" placeholder="Optional…"></textarea>

    <label>What can the trainer improve? (Optional)</label>
    <textarea id="trainerImprovements" placeholder="Optional…"></textarea>
  </div>

  <!-- Training Effectiveness & Compliance (Mandatory) -->
  <div class="section">
    <h3>Training Effectiveness & Compliance (Mandatory)</h3>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Learning objectives were clearly communicated *</label>
        <div class="rating-selected">Selected: <strong id="sel_iso_objectives_clarity">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="iso_objectives_clarity">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Session content aligned with my role requirements *</label>
        <div class="rating-selected">Selected: <strong id="sel_iso_role_alignment">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="iso_role_alignment">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">The session improved my competence/confidence *</label>
        <div class="rating-selected">Selected: <strong id="sel_iso_competence_gain">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="iso_competence_gain">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Training materials / job aids were useful *</label>
        <div class="rating-selected">Selected: <strong id="sel_iso_material_quality">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="iso_material_quality">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <div class="rating-row">
      <div class="rating-head">
        <label style="margin:0;">Training environment supported learning (room/virtual setup) *</label>
        <div class="rating-selected">Selected: <strong id="sel_iso_learning_environment">—</strong>/5</div>
      </div>
      <div class="rating-buttons" data-field="iso_learning_environment">
        <button type="button" data-value="1">1</button><button type="button" data-value="2">2</button>
        <button type="button" data-value="3">3</button><button type="button" data-value="4">4</button>
        <button type="button" data-value="5">5</button>
      </div>
    </div>

    <label>Did you complete the post-training quiz/assessment? *</label>
    <div class="yn-buttons" data-yn-field="iso_assessment_completed">
      <button type="button" data-value="Yes">Yes</button>
      <button type="button" data-value="No">No</button>
    </div>
    <div class="helper">This helps demonstrate assessment evidence for training effectiveness.</div>
  </div>

  <!-- Feedback -->
  <div class="section">
    <h3>Feedback & Suggestions</h3>

    <label>Recommendation Score (NPS) *</label>
    <div class="helper" style="margin-top:0;">
      On a scale of <strong>0 to 10</strong>, how likely are you to recommend this session to a colleague?
      <br><strong>0</strong> = Not at all likely, <strong>10</strong> = Extremely likely
    </div>
    <input type="number" min="0" max="10" id="npsScore" placeholder="Enter 0–10" style="margin-top:10px;">

    <label>What did you like most about the session? *</label>
    <textarea id="likedMost" placeholder="Share key positives…"></textarea>

    <label>What could be improved? *</label>
    <textarea id="toImprove" placeholder="Share suggestions to improve…"></textarea>

    <label>Any other suggestions or topics you’d like us to cover next?</label>
    <textarea id="suggestions" placeholder="Optional…"></textarea>
  </div>

  <button class="submit-btn" id="submitBtn" disabled>Submit Feedback</button>
  <div class="success" id="successMsg">Thank you! Your feedback has been recorded. This page will refresh in 5 seconds.</div>
  <div class="footer-note">© 2026 | Training Feedback Platform</div>

</div>

<!-- Flatpickr JS (optional enhancement) -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

<script>
  // ======= BACKEND URL (your deployed Apps Script /exec) =======
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby4qy0LBzj21Fb_sOU3VaaimYy7uGEY7Q5D9v4LeMCgculx6_tMpKP5MtekPsTd2_i5jg/exec";

  const $ = (id) => document.getElementById(id);

  const el = {
    trainingTopic: $("trainingTopic"),
    trainingDate: $("trainingDate"),
    dateError: $("dateError"),
    location: $("location"),
    empPrefix: $("empPrefix"),
    employeeCode: $("employeeCode"),
    department: $("department"),

    trainerStrengths: $("trainerStrengths"),
    trainerImprovements: $("trainerImprovements"),

    npsScore: $("npsScore"),
    likedMost: $("likedMost"),
    toImprove: $("toImprove"),
    suggestions: $("suggestions"),

    submitBtn: $("submitBtn"),
    successMsg: $("successMsg")
  };

  // Ratings store
  const ratings = {
    overallRating: null,
    contentRelevanceRating: null,
    trainerDeliveryRating: null,
    sessionPaceRating: null,
    usefulnessRating: null,

    trainerKnowledgeRating: null,
    trainerEngagementRating: null,
    trainerResponsivenessRating: null,
    trainerExamplesRating: null,

    iso_objectives_clarity: null,
    iso_role_alignment: null,
    iso_competence_gain: null,
    iso_material_quality: null,
    iso_learning_environment: null
  };

  // Yes/No state
  let iso_assessment_completed = null;

  document.addEventListener("DOMContentLoaded", () => {
    setDateConstraints();

    // Enhance with Flatpickr if available; never crash if CDN is blocked
    try {
      if (typeof flatpickr !== "undefined") {
        flatpickr(el.trainingDate, {
          dateFormat: "Y-m-d",
          maxDate: "today",
          minDate: dateMinusDays(60),
          disableMobile: true,
          allowInput: false,
          onChange: () => { el.dateError.style.display = "none"; validate(); }
        });
      }
    } catch (e) {
      // Native date picker still works
    }

    // Rating buttons binding
    document.querySelectorAll(".rating-buttons").forEach(group => {
      const field = group.dataset.field;
      group.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const val = Number(btn.dataset.value);
          ratings[field] = val;

          group.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");

          const indicator = $("sel_" + field);
          if (indicator) indicator.textContent = String(val);

          validate();
        });
      });
    });

    // Yes/No binding
    document.querySelectorAll(".yn-buttons").forEach(group => {
      const f = group.dataset.ynField;
      group.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          if (f !== "iso_assessment_completed") return;
          iso_assessment_completed = btn.dataset.value;

          group.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");

          validate();
        });
      });
    });

    // Validate on input changes
    document.querySelectorAll("input, select, textarea").forEach(x => {
      x.addEventListener("input", validate);
      x.addEventListener("change", validate);
    });

    validate();
  });

  function dateMinusDays(days){
    const d = new Date();
    d.setDate(d.getDate() - days);
    d.setHours(0,0,0,0);
    return d;
  }

  function setDateConstraints(){
    const max = new Date();
    const min = dateMinusDays(60);

    const fmt = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    };

    el.trainingDate.max = fmt(max);
    el.trainingDate.min = fmt(min);
  }

  function isDateWithinRange(yyyyMmDd){
    if (!yyyyMmDd) return false;
    const chosen = new Date(yyyyMmDd + "T00:00:00");
    const max = new Date(); max.setHours(0,0,0,0);
    const min = dateMinusDays(60);
    return chosen >= min && chosen <= max;
  }

  function validate(){
    const dateOk = isDateWithinRange(el.trainingDate.value);

    const npsVal = el.npsScore.value;
    const npsOk = npsVal !== "" && Number(npsVal) >= 0 && Number(npsVal) <= 10;

    const baseOk =
      el.trainingTopic.value.trim() &&
      dateOk &&
      el.location.value &&
      el.empPrefix.value && el.employeeCode.value.trim() &&
      el.department.value &&
      npsOk &&
      el.likedMost.value.trim() &&
      el.toImprove.value.trim();

    const ratingsOk = Object.values(ratings).every(v => v !== null);
    const complianceOk = iso_assessment_completed !== null;

    el.submitBtn.disabled = !(baseOk && ratingsOk && complianceOk);
  }

  el.submitBtn.addEventListener("click", async () => {
    if (!isDateWithinRange(el.trainingDate.value)) {
      el.dateError.style.display = "block";
      return;
    }

    el.submitBtn.textContent = "Submitting...";
    el.submitBtn.disabled = true;

    const payload = {
      trainingTopic: el.trainingTopic.value.trim(),
      trainingDate: el.trainingDate.value.trim(),
      location: el.location.value,
      employeeCode: `${el.empPrefix.value}-${el.employeeCode.value.trim()}`,
      department: el.department.value,

      overallRating: ratings.overallRating,
      contentRelevanceRating: ratings.contentRelevanceRating,
      trainerDeliveryRating: ratings.trainerDeliveryRating,
      sessionPaceRating: ratings.sessionPaceRating,
      usefulnessRating: ratings.usefulnessRating,

      trainerKnowledgeRating: ratings.trainerKnowledgeRating,
      trainerEngagementRating: ratings.trainerEngagementRating,
      trainerResponsivenessRating: ratings.trainerResponsivenessRating,
      trainerExamplesRating: ratings.trainerExamplesRating,
      trainerStrengths: el.trainerStrengths.value.trim(),
      trainerImprovements: el.trainerImprovements.value.trim(),

      iso_objectives_clarity: ratings.iso_objectives_clarity,
      iso_role_alignment: ratings.iso_role_alignment,
      iso_competence_gain: ratings.iso_competence_gain,
      iso_material_quality: ratings.iso_material_quality,
      iso_learning_environment: ratings.iso_learning_environment,
      iso_assessment_completed: iso_assessment_completed,

      npsScore: Number(el.npsScore.value),
      likedMost: el.likedMost.value.trim(),
      toImprove: el.toImprove.value.trim(),
      suggestions: el.suggestions.value.trim()
    };

    try {
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const out = await res.json().catch(() => ({}));
      if (!res.ok || out.status !== "ok") throw new Error(out.message || `HTTP ${res.status}`);

      el.successMsg.style.display = "block";
      el.submitBtn.textContent = "Submitted";

      setTimeout(() => window.location.reload(), 5000);

    } catch (e) {
      alert("Submission failed. Please try again. If it persists, contact HR/L&D.");
      el.submitBtn.textContent = "Submit Feedback";
      el.submitBtn.disabled = false;
    }
  });
</script>

</body>
</html>
